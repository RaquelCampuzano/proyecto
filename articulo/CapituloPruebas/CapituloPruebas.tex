% !TEX root =../LibroTipoETSI.tex
\section{Pruebas realizadas}
\subsection{Pruebas de laboratorio}
\subsubsection{Entorno del laboratorio}

El equipo \gls{DUT} es un redBorder IPS de 8 hilos (1 quad-core de 2 hilos por core) Intel Xeon E3-1240 a 3.30GHz. La 
interfaz del segmento de inspección es una intel quad-ethernet 82580 Gigabit con soporte bypass. En el sensor se ha 
instalado la distribución \emph{redBorder-IPS-sensor 3.0.30-1}, basada en la distribución Linux CentOS 6.5.

Como generador de tráfico, se usará otro dispositivo con las mismas características. Los segmentos de $1G$ se unirán de 
un equipo a otro en el mismo orden, a fin de facilitar el entendimiento de las pruebas, y serán llamados 
\text{eth4}, \text{eth5}, \text{eth6}, y \text{eth7} de izquierda a derecha.

Se dispone, además de una captura de tráfico llamada \emph{entrenamiento.pcap}, que contiene tráfico real sin ataques,
y que reproduciremos gracias al comando \texttt{tcpreplay}.

\subsubsection{Prueba 1: Ajuste de los parámetros CUSUM para evitar falsos positivos}
\paragraph{Descripción de la prueba}\mbox{}

El primer paso de cara a realizar las pruebas es conseguir un valor adecuado del número de desviaciones límites
para tener en cuenta la medida y para generar una alarma.

\paragraph{Procedimiento}\mbox{}

Con un PCAP concreto, se debe realizar un periodo de aprendizaje. Tras él, se debe realizar un
periodo de defensa con el mismo PCAP y los valores límites propuestos. Si éstos generan alertas,
significa que esos valores son extremadamente bajos.

\paragraph{Resultados}\mbox{}

Como valores iniciales, se escogieron los recomendados por Ismael Sánchez, $C_i^+=5$ y $C_i^{min}=2.5$
 \cite{CUSUM_Carlos_III}.

Tras realizar las pruebas, se observó que la naturaleza de la red de datos, en el que el tráfico suele ser la 
mayor parte del tiempo $0$ y, durante un breve intervalo de tiempo, un valor elevado, provocaban que fuese necesario
el aumento de esos valores iniciales, que finalmente fueron establecidos a $C_i^+=10$ y $C_i^{min}=5$. Esto fue
especialmente influyente en el tráfico \gls{ICMP}, por lo que se decidió no tenerlo en cuenta para generar alarmas.

\subsubsection{Prueba 2: Detección de IPs atacantes, control de falsos negativos y estado de 
alerta}
\paragraph{Descripción de la prueba}\mbox{}

Para esta prueba, se necesitarán las cuatro interfaces de red. Con el aprendizaje de la prueba anterior, se hará pasar 
la captura \emph{entrenamiento.pcap} por uno de los dos segmentos, mientras que en el otro, al cabo de un tiempo $T_0$, 
se hará pasar tráfico claramente atacante: una ráfaga de paquetes UDP a alta velocidad, desde un pcap preparado.

Se modificará \texttt{rbddos} para que emita un mensaje si, en un ciclo, se ha visto bajo ataque, y para que emita el 
tráfico total visto. De esta forma, podremos saber si el programa funciona correctamente. Las IP normales estarán en 
una red distinta de las atacante (\texttt{172.26.0.0/16} frente a \texttt{10.0.0.0/8})

Se utilizarán los datos de entrenamiento de la anterior prueba.

\endinput

\paragraph{Procedimiento}
Se arranca el programa, ya en modo defensa por los datos aprendidos
\begin{verbatim}
[root@DUT rbddos]# ./rbddos -i eth4 -o eth7 -c 99 -r 0 -g 1:2:3:4:5:6  -m 7 -d -s 1024 -l /var/log/ddos.log.*
\end{verbatim}

Se hace pasar el tráfico por un segmento vía \texttt{tcpreplay}:
\begin{verbatim}
 tcpreplay --cachefile entrenamiento.cache --intf1=eth4 --intf2=eth5 entrenamiento.pcap
\end{verbatim}

Pasados 20 segundos, se hace pasar el tráfico UDP a alta velocidad por el otro segmento:
\begin{verbatim}
 tcpreplay -t --cachefile udp.cache --intf1=eth6 --intf2=eth7 udp.pcap
\end{verbatim}

Se detiene el pcap a los 10 segundos. Tras ello, se analiza la salida, y se registra, con la salida de depuración:
\begin{itemize}
 \item Número de paquetes analizados por el programa.
 \item Si el programa ha estado en alerta o no.
\end{itemize}

\paragraph{Reultados}

\begin{figure}[htbp]
\centering
\includegraphics[width=\textwidth]{CapituloPruebas/Figuras/pruebaTrafico-crop}
\caption{Resultados de la prueba}
\LABFIG{PruebaTrafico}
\end{figure}
%

En los resultados, \texttt{rbddos} fue capaz de marcar los momentos ajo ataque a distintas velocidades, y todos los 
elementos atacantes pertenecían al conjunto de direcciones IP correctos.

\subsection{Prueba realizada en Produban}\LABSEC{PruebaProduban}
\subsubsection{Entorno}
El día 4 de mayo de 2013, Produbán, empresa de gestión IT del grupo Santanter, pidió a Eneo un sistema que de detección 
de ataques \gls{DDoS}, dado que tenía la sospecha de que se iba a producir un ataque real a su infraestructura.

Pese a estar aún en un estado muy prematuro, Produban aceptó la instalación del software ya que no entrañaba riesgo 
para la infraestructura al estar este situado en un puerto SPAN.

\begin{figure}[hbtp]
\centering
%\hfill
\subfloat[Frontal del sensor]%
   {\LABFIG{ProdubanFrontal}%
   \includegraphics[width=0.49\textwidth]{CapituloPruebas/Figuras/ProdubanFrontal}}
\hfill
\subfloat[Parte trasera del sensor]%
   {\LABFIG{ProdubanTrasera}%
   \includegraphics[width=0.49\textwidth]{CapituloPruebas/Figuras/ProdubanTrasera}}
%
\caption{Instalación de \redborderddos{} en el CPD de Mesena, Produban}
\end{figure}
%
El sensor usado es un equipo 2U con doble procesador Xeon E5 y 64GB de RAM, con 2 puertos dedicados de gestión y otros 
2 puertos 10G para conectarse a un puerto de SPAN, y es instalado en el CPD de Mesena.

En la \FIG{ProdubanFrontal} podemos ver la parte frontal del sensor, en la que fueron instalados dos pares de fibra 
óptica dirigidas a un puerto SPAN. Por otro lado, en la parte trasera, vemos la conexión de la interfaz de gestión y el 
puerto IPMI, una interfaz especial dirigida a manejar el sensor por web.

\subsubsection{Resultados}
Debido a lo inmediato de la instalación, fue imposible ajustar el sensor para que diese resultados significativos. Con 
sólo tres horas de entrenamiento, y sin ser estas siquiera determinantes, era muy difícil que la prueba diese 
resultados satisfactorios.

Los resultados fueron, en cuanto al periodo de aprendizaje:
\begin{table}[htbp]
 \centering
 \begin {tabular}{lll}
  Parámetro & Media & Desviación típica  \\\hline
  Paquetes TCP & 93\% & 0.02 \\
  Paquetes UDP & 5\%  & 0.02 \\
  Paquetes ICMP & 0 & 0      \\
  Relación I/O & 32,41 & 13,75 \\
  Longitud media del flujo & 593.54 & 59.57 \\
  Relación SYN/(SYN+ACK) & 593.54 & 59.57   
 \end {tabular}
\end{table}

Debido al estado altamente prematuro de la aplicación, el resultado de la relación SYN/(SYN+ACK) fue confiundido con el 
de la longitud media del flujo. Esto, junto con el escaso margen que tenían los valores ICMP, provocaron que el número 
de alarmas emitidas fuese enorme.

El programa estuvo ejecutándose desde el 7 de mayo a las 11:53\footnote{Timestamp: 1367920409} hasta el 15 de mayo a 
las 11:36, y se generaron más de 100 millones de alarmas.

Las conclusiones principales que se extrayeron fue que la realidad era mucho más cambiante de lo que permitía discernir 
tres horas de entrenamiento, o incluso un día, y que se debería de adaptar el protocolo CUSUM para hacer frente a esa 
realidad.

\subsection{Conclusiones}
Tras analizar las pruebas realizadas en este capítulo, se observa que el algoritmo CUSUM se enfrenta bien a las pruebas 
de laboratiorio, pero es incapaz, como lo hemos planteado, de hacer frente a una muestra variable como es el tráfico 
que enfrenta un sistema a lo largo del tiempo. Así pues, se deberán buscar o bien otros sistemas de control de 
procesos, o bien modificar el algoritmo CUSUM para lograr analizar correctamente dicha variablidad.


\endinput
